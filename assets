/* SpeakXR X-Stage PRO (LIVE) â€” static, works on GitHub Pages */

const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

/* ---------------- Router ---------------- */
function go(page){
  const id = `page-${page}`;
  $$('.page').forEach(p => p.classList.remove('active'));
  const t = document.getElementById(id);
  if(t) t.classList.add('active');
  $$('.navBtn').forEach(b => b.classList.toggle('active', b.dataset.go === page));
  history.replaceState({}, '', `#${page}`);
}
$$('.navBtn').forEach(b => b.addEventListener('click', () => go(b.dataset.go)));
window.addEventListener('load', () => go((location.hash || '#home').slice(1)));
window.addEventListener('hashchange', () => go((location.hash || '#home').slice(1)));

/* ---------------- State ---------------- */
let sessionOn = false;
let t = 0;
let timer = null;

let arOn = false, hudOn = true, audOn = false, teleOn = false, vrOn = false, sttOn = false;
let marks = 0;

const dot = $('#dot'), stTitle = $('#stTitle'), stSub = $('#stSub');
const pillMode = $('#pillMode'), pillAR = $('#pillAR'), pillAud = $('#pillAud'), pillSTT = $('#pillSTT');

const cam = $('#cam');
const hud = $('#hud');
const audience = $('#audience');
const tele = $('#tele');
const vr = $('#vr');

const hudTimer = $('#hudTimer');
const kTime = $('#kTime'), kWpm = $('#kWpm'), kFiller = $('#kFiller'), kConf = $('#kConf'), kEnergy = $('#kEnergy'), kClarity = $('#kClarity');

const audPower = $('#audPower');
const teleSpeed = $('#teleSpeed');
const hudSize = $('#hudSize');

const teleText = $('#teleText');
const scriptInput = $('#scriptInput');
const teleArea = $('#teleArea');

const transcriptEl = $('#transcript');

const vu = $('#vu');
const vuctx = vu.getContext('2d');
const micState = $('#micState');
const micPeak = $('#micPeak');
const micMarks = $('#micMarks');

const hintOverlay = $('#hintOverlay');
const hintText = $('#hintText');

function fmt(sec){
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

function setStatus(colorVar, title, sub){
  dot.style.background = `var(${colorVar})`;
  stTitle.textContent = title;
  stSub.textContent = sub;
}

function showHint(text){
  hintText.textContent = text;
  hintOverlay.hidden = false;
}
function hideHint(){
  hintOverlay.hidden = true;
}

$('#closeHint').addEventListener('click', hideHint);
$('#retryPerms').addEventListener('click', async ()=>{ hideHint(); await ensureAR(); });

/* ---------------- Theme ---------------- */
let dark = true;
$('#themeBtn').addEventListener('click', ()=>{
  dark = !dark;
  document.documentElement.style.filter = dark ? 'none' : 'invert(1) hue-rotate(180deg)';
});
$('#helpBtn').addEventListener('click', ()=>{
  showHint(
`1) AR Camera: ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.\n2) ØªØ³Ø¬ÙŠÙ„: ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒ.\n3) STT: ÙŠØ¯Ø¹Ù…Ù‡Ø§ Chrome ØºØ§Ù„Ø¨Ù‹Ø§.\nØ¥Ø°Ø§ Ø±ÙØ¶Øª ØµÙ„Ø§Ø­ÙŠØ©: Ø§ÙØªØ­ Site settings ÙˆØ§Ø³Ù…Ø­.`
  );
});

/* ---------------- HUD sizing ---------------- */
hudSize.addEventListener('input', ()=>{
  hud.style.fontSize = `${hudSize.value}px`;
});

/* ---------------- Teleprompter ---------------- */
function applyTele(text){
  const v = (text || '').trim();
  teleText.textContent = v || 'Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ Ø«Ù… â€œØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Øµâ€.';
  if(teleOn){
    tele.removeAttribute('aria-hidden');
  }
}
$('#applyScript').addEventListener('click', ()=> applyTele(scriptInput.value));
$('#teleApply').addEventListener('click', ()=> applyTele(teleArea.value));
$('#teleClear').addEventListener('click', ()=> { teleArea.value=''; applyTele(''); });

/* ---------------- Toggles ---------------- */
function syncPills(){
  pillMode.textContent = `MODE: ${sessionOn ? 'LIVE' : 'READY'}`;
  pillAR.textContent = `AR: ${arOn ? 'ON' : 'OFF'}`;
  pillAud.textContent = `AUD: ${audPower.value}`;
  pillSTT.textContent = `STT: ${sttOn ? 'ON' : 'OFF'}`;
}
function setHud(on){
  hudOn = on;
  hud.style.display = hudOn ? 'block' : 'none';
}
function setTele(on){
  teleOn = on;
  if(teleOn){
    tele.removeAttribute('aria-hidden');
    tele.style.display = 'block';
  }else{
    tele.setAttribute('aria-hidden', 'true');
    tele.style.display = 'none';
  }
}
function setAudience(on){
  audOn = on;
  audience.style.display = audOn ? 'block' : 'none';
  audience.setAttribute('aria-hidden', audOn ? 'false' : 'true');
  if(audOn) startAudience();
}
function setVR(on){
  vrOn = on;
  vr.style.display = vrOn ? 'block' : 'none';
  vr.setAttribute('aria-hidden', vrOn ? 'false' : 'true');
}
async function setAR(on){
  arOn = on;
  if(arOn){
    await ensureAR();
    cam.classList.add('on');
  }else{
    cam.classList.remove('on');
    stopAR();
  }
  syncPills();
}
async function setSTT(on){
  sttOn = on;
  if(sttOn){
    startSTT();
  }else{
    stopSTT();
  }
  syncPills();
}

$('#toggleAR').addEventListener('click', ()=> setAR(!arOn));
$('#toggleHUD').addEventListener('click', ()=> setHud(!hudOn));
$('#toggleAudience').addEventListener('click', ()=> setAudience(!audOn));
$('#toggleTele').addEventListener('click', ()=> setTele(!teleOn));
$('#toggleVR').addEventListener('click', ()=> setVR(!vrOn));
$('#toggleSTT').addEventListener('click', ()=> setSTT(!sttOn));

$('#xrAR').addEventListener('click', ()=> setAR(!arOn));
$('#xrHUD').addEventListener('click', ()=> setHud(!hudOn));
$('#xrAud').addEventListener('click', ()=> setAudience(!audOn));
$('#xrTele').addEventListener('click', ()=> setTele(!teleOn));
$('#xrVR').addEventListener('click', ()=> setVR(!vrOn));
$('#xrSTT').addEventListener('click', ()=> setSTT(!sttOn));

audPower.addEventListener('input', ()=> syncPills());

/* ---------------- Session Timer ---------------- */
function tick(){
  t++;
  const time = fmt(t);
  hudTimer.textContent = time;
  kTime.textContent = time;

  // WPM estimate: words counted from transcript or script
  const txt = (transcriptText || scriptInput.value || teleArea.value || '').trim();
  const words = txt ? txt.split(/\s+/).filter(Boolean).length : 0;
  const minutes = Math.max(1/60, t/60);
  const wpm = Math.round(words / minutes);

  // filler count
  const fillers = countFillers(txt);

  // energy/clarity from mic peak + wpm stability (simple heuristics)
  const peak = lastPeak || 0;
  const energy = clamp(Math.round(peak * 120), 0, 100);
  const clarity = clamp(Math.round(60 + (peak*60) - (fillers*2) + (wpm>160?-10:0)), 0, 100);

  // confidence: blend energy + clarity + audience power
  const conf = clamp(Math.round((energy*0.35) + (clarity*0.45) + (Number(audPower.value)*0.20)), 0, 100);

  kWpm.textContent = isFinite(wpm) ? wpm : 0;
  kFiller.textContent = fillers;
  kEnergy.textContent = energy;
  kClarity.textContent = clarity;
  kConf.textContent = `${conf}%`;

  // update audience dynamics
  if(audOn) updateAudience(conf, wpm, fillers);
}

$('#startBtn').addEventListener('click', ()=>{
  if(sessionOn) return;
  sessionOn = true;
  t = 0;
  marks = 0;
  micMarks.textContent = '0';
  setStatus('--ok', 'LIVE', 'Ø§Ù„Ø¬Ù„Ø³Ø© Ø´ØºÙ‘Ø§Ù„Ø©â€¦ ÙˆØ±Ù‘Ù†Ø§ Ø§Ù„ÙˆØ­Ø´ ğŸ‘‘');
  $('#stopBtn').disabled = false;
  $('#startBtn').disabled = true;

  syncPills();
  hudTimer.textContent = '00:00';
  kTime.textContent = '00:00';

  timer = setInterval(tick, 1000);
});

$('#stopBtn').addEventListener('click', ()=>{
  if(!sessionOn) return;
  sessionOn = false;
  if(timer) clearInterval(timer);
  timer = null;
  setStatus('--warn', 'Ù…ØªÙˆÙ‚Ù', 'Ø§Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ Ø³Ùˆ ØªÙ‚Ø±ÙŠØ±');
  $('#stopBtn').disabled = true;
  $('#startBtn').disabled = false;
  syncPills();
});

/* ---------------- WOW Buttons ---------------- */
$('#wowBtn').addEventListener('click', ()=>{
  go('xr');
  setHud(true);
  setTele(true);
  setAudience(true);
  setVR(false);
  audPower.value = 86;
  syncPills();
  pushBot(`Ø´ØºÙ‘Ù„Øª Ù„Ùƒ ÙˆØ¶Ø¹ WOW: HUD + ØªÙ„Ù‚ÙŠÙ† + Ø¬Ù…Ù‡ÙˆØ±. Ø§Ù„Ø¢Ù† Ø§Ø¶ØºØ· â€œØ¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©â€ ÙˆØ§Ø¨Ø¯Ø£ ØªØªÙƒÙ„Ù….`);
});

$('#boostBtn').addEventListener('click', ()=>{
  audPower.value = clamp(Number(audPower.value) + 10, 0, 100);
  syncPills();
});

$('#helpBtn').addEventListener('dblclick', ()=> pushBot('Ù„Ø§ ØªØ¶Ø±Ø¨ Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø±ØªÙŠÙ†â€¦ Ø¨ÙŠØ­Ø³Ø¨Ùƒ Ù…ØªÙˆØªØ± ğŸ˜„'));

/* ---------------- AR Camera ---------------- */
let camStream = null;

async function ensureAR(){
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    showHint('Ø¬Ù‡Ø§Ø²Ùƒ/Ù…ØªØµÙØ­Ùƒ Ù…Ø§ ÙŠØ¯Ø¹Ù… getUserMedia. Ø¬Ø±Ù‘Ø¨ Chrome.');
    arOn = false; syncPills();
    return;
  }
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio:false });
    cam.srcObject = camStream;
    cam.play().catch(()=>{});
  }catch(e){
    arOn = false; syncPills();
    showHint('Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø±ÙØ¶Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. Ø§ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Site settings) ÙˆØ§Ø³Ù…Ø­ Camera Ø«Ù… Retry.');
  }
}
function stopAR(){
  if(camStream){
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
  cam.srcObject = null;
}

/* ---------------- Microphone + Visualizer + Recording ---------------- */
let audioStream = null;
let audioCtx = null;
let analyser = null;
let dataArr = null;
let raf = null;
let lastPeak = 0;

let mediaRecorder = null;
let chunks = [];
let recording = false;

async function ensureMic(){
  if(!navigator.mediaDevices?.getUserMedia){
    showHint('Ø§Ù„Ù…Ø§ÙŠÙƒ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù‡Ù†Ø§. Ø¬Ø±Ù‘Ø¨ Chrome.');
    return false;
  }
  try{
    audioStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(audioStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    dataArr = new Uint8Array(analyser.frequencyBinCount);
    src.connect(analyser);
    drawVU();
    return true;
  }catch(e){
    showHint('Ø§Ù„Ù…Ø§ÙŠÙƒ Ø±ÙØ¶ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©. Ø§Ø³Ù…Ø­ Microphone Ù…Ù† Site settings Ø«Ù… Ø¬Ø±Ù‘Ø¨.');
    return false;
  }
}

function drawVU(){
  if(!analyser) return;
  analyser.getByteFrequencyData(dataArr);
  vuctx.clearRect(0,0,vu.width,vu.height);

  // background
  vuctx.fillStyle = 'rgba(255,255,255,0.04)';
  vuctx.fillRect(0,0,vu.width,vu.height);

  // bars
  const bars = 56;
  const step = Math.floor(dataArr.length / bars);
  let peak = 0;
  for(let i=0;i<bars;i++){
    const v = dataArr[i*step] / 255;
    peak = Math.max(peak, v);
    const h = Math.max(2, v * (vu.height-10));
    const x = (i*(vu.width/bars));
    vuctx.fillStyle = `rgba(33,230,164,${0.35 + v*0.55})`;
    vuctx.fillRect(x, vu.height-h, (vu.width/bars)-2, h);
  }
  lastPeak = peak;
  micPeak.textContent = peak.toFixed(2);

  raf = requestAnimationFrame(drawVU);
}

$('#recBtn').addEventListener('click', async ()=>{
  if(!recording){
    const ok = await ensureMic();
    if(!ok) return;

    // recorder
    try{
      chunks = [];
      mediaRecorder = new MediaRecorder(audioStream);
      mediaRecorder.ondataavailable = (e)=> chunks.push(e.data);
      mediaRecorder.onstop = ()=> {
        const blob = new Blob(chunks, { type: chunks[0]?.type || 'audio/webm' });
        const url = URL.createObjectURL(blob);
        pushBot(`ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. (ØªØ­Ù…ÙŠÙ„)`);
        // create a download link message
        addDownloadLink(url, `speakxr_record_${Date.now()}.webm`);
      };
      mediaRecorder.start();
      recording = true;
      micState.textContent = 'Recording';
      $('#recBtn').textContent = 'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
      setStatus('--ok', 'Recording', 'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø´ØºØ§Ù„â€¦');
    }catch(e){
      showHint('Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ø¬Ø±Ù‘Ø¨ Chrome.');
    }
  }else{
    // stop
    recording = false;
    micState.textContent = 'Idle';
    $('#recBtn').textContent = 'ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„';
    setStatus('--warn', 'Stopped', 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„.');
    if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }
});

function stopMicAll(){
  if(raf) cancelAnimationFrame(raf);
  raf = null;
  try{ audioCtx?.close(); }catch{}
  audioCtx = null;
  analyser = null;
  dataArr = null;

  if(audioStream){
    audioStream.getTracks().forEach(t => t.stop());
    audioStream = null;
  }
}
window.addEventListener('beforeunload', ()=> {
  stopAR();
  stopMicAll();
  stopSTT();
});

$('#markBtn').addEventListener('click', ()=>{
  marks++;
  micMarks.textContent = String(marks);
  pushBot(`ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© #${marks} Ø¹Ù†Ø¯ ${fmt(t)} âœ…`);
});

/* ---------------- STT (Speech to Text) ---------------- */
let rec = null;
let transcriptText = '';

function startSTT(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    showHint('SpeechRecognition ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù‡Ù†Ø§. Ø¬Ø±Ù‘Ø¨ Chrome.');
    sttOn = false; syncPills();
    return;
  }
  rec = new SR();
  rec.lang = 'ar-SA';
  rec.interimResults = true;
  rec.continuous = true;

  rec.onresult = (e)=>{
    let finalText = '';
    let interim = '';
    for(let i=e.resultIndex;i<e.results.length;i++){
      const txt = e.results[i][0].transcript;
      if(e.results[i].isFinal) finalText += txt + ' ';
      else interim += txt;
    }
    if(finalText.trim()){
      transcriptText += finalText;
    }
    transcriptEl.textContent = (transcriptText + '\n' + (interim ? `â€¦ ${interim}` : '')).trim() || 'â€”';
  };

  rec.onerror = ()=>{
    // if permission etc
  };
  rec.onend = ()=>{
    // auto-restart while sttOn
    if(sttOn){
      try{ rec.start(); }catch{}
    }
  };

  try{ rec.start(); }catch{}
  pushBot('ØªÙ… ØªØ´ØºÙŠÙ„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù… Ù„Ù†Øµ (STT).');
}
function stopSTT(){
  try{ rec?.stop(); }catch{}
  rec = null;
}
$('#copyTranscript').addEventListener('click', async ()=>{
  const txt = transcriptEl.textContent || '';
  try{ await navigator.clipboard.writeText(txt); pushBot('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…'); }catch{ pushBot('Ø§Ù„Ù†Ø³Ø® ÙØ´Ù„.'); }
});
$('#clearTranscript').addEventListener('click', ()=>{
  transcriptText = '';
  transcriptEl.textContent = 'â€”';
});

/* ---------------- Audience (canvas particles) ---------------- */
const audCanvas = $('#aud');
const auctx = audCanvas.getContext('2d');
let audRAF = null;
let particles = [];
let audClaps = 0;

function resizeAud(){
  // keep internal resolution sharp-ish
  const w = audCanvas.clientWidth || 900;
  const h = audCanvas.clientHeight || 320;
  audCanvas.width = Math.floor(w * devicePixelRatio);
  audCanvas.height = Math.floor(h * devicePixelRatio);
  auctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener('resize', resizeAud);

function initAudience(){
  resizeAud();
  particles = [];
  const n = 120;
  for(let i=0;i<n;i++){
    particles.push({
      x: Math.random()* (audCanvas.width/devicePixelRatio),
      y: Math.random()* (audCanvas.height/devicePixelRatio),
      r: 2 + Math.random()*3,
      vx: (-0.6 + Math.random()*1.2),
      vy: (-0.4 + Math.random()*0.8),
      o: 0.25 + Math.random()*0.65
    });
  }
}

function startAudience(){
  if(!particles.length) initAudience();
  if(audRAF) return;
  const loop = ()=>{
    drawAudience();
    audRAF = requestAnimationFrame(loop);
  };
  loop();
}
function stopAudience(){
  if(audRAF) cancelAnimationFrame(audRAF);
  audRAF = null;
}

function drawAudience(){
  const w = audCanvas.width/devicePixelRatio;
  const h = audCanvas.height/devicePixelRatio;
  auctx.clearRect(0,0,w,h);

  // bg glow
  const g = auctx.createRadialGradient(w*0.5,h*0.3,30,w*0.5,h*0.5,Math.max(w,h));
  g.addColorStop(0,'rgba(124,92,255,0.18)');
  g.addColorStop(1,'rgba(0,0,0,0.0)');
  auctx.fillStyle = g;
  auctx.fillRect(0,0,w,h);

  const power = Number(audPower.value);
  const speed = 0.3 + power/220;

  for(const p of particles){
    p.x += p.vx*speed;
    p
