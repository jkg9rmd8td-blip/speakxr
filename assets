// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
let recognition;
let isRecording = false;
let timerInterval;
let seconds = 0;
let wordCount = 0;

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù„ÙƒÙ„Ø§Ù…
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'ar-SA'; // Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©

    recognition.onresult = (event) => {
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                // Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
                const transcript = event.results[i][0].transcript;
                updateLiveText(transcript, true);
                
                // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ§Ù‹
                wordCount += transcript.split(' ').length;
                updateWPM();
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }
        if(interimTranscript) updateLiveText(interimTranscript, false);
    };
} else {
    alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome.");
}

// 1. Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³Ø±Ø­
function enterStage() {
    const dashboard = document.getElementById('dashboard-view');
    const stage = document.getElementById('stage-view');

    // Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
    dashboard.style.opacity = '0';
    dashboard.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
        dashboard.style.display = 'none';
        stage.style.display = 'block';
    }, 400);
}

// 2. Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…Ø³Ø±Ø­
function exitStage() {
    const dashboard = document.getElementById('dashboard-view');
    const stage = document.getElementById('stage-view');

    if(isRecording) toggleMic(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø´ØºØ§Ù„Ø§Ù‹

    stage.style.display = 'none';
    dashboard.style.display = 'flex';
    
    setTimeout(() => {
        dashboard.style.opacity = '1';
        dashboard.style.transform = 'scale(1)';
    }, 50);
}

// 3. ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§ÙŠÙƒ
function toggleMic() {
    const btn = document.getElementById('mic-btn');
    const msg = document.getElementById('coach-msg');

    if(!isRecording) {
        // Ø¨Ø¯Ø¡
        recognition.start();
        isRecording = true;
        btn.classList.add('recording');
        msg.innerText = "ğŸ¤ Ø£Ù†Ø§ Ø£Ø³Ù…Ø¹Ùƒ.. Ø§Ù†Ø·Ù„Ù‚!";
        startTimer();
    } else {
        // Ø¥ÙŠÙ‚Ø§Ù
        recognition.stop();
        isRecording = false;
        btn.classList.remove('recording');
        msg.innerText = "âœ… Ø£Ø­Ø³Ù†Øª! Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡...";
        stopTimer();
    }
}

// 4. Ø§Ù„Ù…Ø¤Ù‚Øª
function startTimer() {
    seconds = 0;
    wordCount = 0;
    timerInterval = setInterval(() => {
        seconds++;
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${mins}:${secs}`;
        
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªØºÙŠÙŠØ± Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
        if(seconds % 5 === 0) updateAudienceMood();
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
}

// 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
function updateLiveText(text, isFinal) {
    const el = document.getElementById('live-text');
    el.innerText = text;
    if(isFinal) {
        // ØªØ£Ø«ÙŠØ± ÙˆÙ…ÙŠØ¶ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¬Ù…Ù„Ø©
        el.style.opacity = '0.7';
        setTimeout(() => el.style.opacity = '1', 200);
    }
}

// 6. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø© WPM
function updateWPM() {
    const mins = seconds / 60;
    if(mins > 0) {
        const wpm = Math.round(wordCount / mins);
        document.getElementById('hud-wpm').innerText = wpm;
    }
}

// 7. Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± (Ù…Ø­Ø§ÙƒØ§Ø©)
function updateAudienceMood() {
    const moods = ['ğŸ™‚', 'ğŸ¤”', 'ğŸ¤©', 'ğŸ‘', 'ğŸ§'];
    const randomMood = moods[Math.floor(Math.random() * moods.length)];
    document.getElementById('mood-emoji').innerText = randomMood;
}
