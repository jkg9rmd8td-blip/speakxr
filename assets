/* =========================
   SpeakXR â€” WOW X-Stage PRO
   FILE: /assets/app.js
   ØªÙØ¹ÙŠÙ„ ÙƒØ§Ù…Ù„: Tabs/Views + Stage + HUD + Audience + Teleprompter + FX + Coach + Jury + Reports
   ========================= */

(() => {
  "use strict";

  /* ---------- Helpers ---------- */
  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
  const rnd = (a, b) => a + Math.random() * (b - a);
  const nowISO = () => new Date().toISOString();

  const STORAGE_KEY = "speakxr_xstage_sessions_v1";

  /* ---------- Safe DOM ---------- */
  const el = {
    // top
    tabs: $("#tabs"),
    status: $("#status"),
    dot: $("#dot"),

    // nav (tabs)
    tabBtns: $$(".tab"),

    // views
    views: $$(".view"),

    // quick hero
    kpiSessions: $("#kpiSessions"),
    kpiBest: $("#kpiBest"),
    kpiReady: $("#kpiReady"),

    // live mini stats
    wpmV: $("#wpmV"),
    enV: $("#enV"),
    clV: $("#clV"),
    auV: $("#auV"),
    wpmBar: $("#wpmBar"),
    enBar: $("#enBar"),
    clBar: $("#clBar"),
    auBar: $("#auBar"),
    coachBox: $("#coachBox"),

    // last report mini
    rScore: $("#rScore"),
    rDecision: $("#rDecision"),
    rSummary: $("#rSummary"),
    rCount: $("#rCount"),

    // actions
    startAll: $("#startAll"),
    stopAll: $("#stopAll"),
    cmdBtn: $("#cmdBtn"),
    presentBtn: $("#presentBtn"),

    // buttons (demo)
    goStageBtn: $("#goStageBtn"),
    pickScenarioBtn: $("#pickScenarioBtn"),
    downloadReportBtn: $("#downloadReportBtn"),
    saveNow: $("#saveNow"),
    exportHTML: $("#exportHTML"),
    exportJSON: $("#exportJSON"),
    wipe: $("#wipe"),

    // scenario grid
    scenarioBtns: $$(".scPro"),

    // settings
    pressure: $("#pressure"),
    audienceSense: $("#audienceSense"),
    autoTele: $("#autoTele"),
    fxOn: $("#fxOn"),
    ccOn: $("#ccOn"),
    coachModeSeg: $("#coachModeSeg"),

    // executive
    exSessions: $("#exSessions"),
    exBest: $("#exBest"),
    exLast: $("#exLast"),
    exReady: $("#exReady"),
    execText: $("#execText"),
    exportExecutive: $("#exportExecutive"),
    goStage2: $("#goStage2"),
    goStage3: $("#goStage3"),

    // webxr
    xrSupport: $("#xrSupport"),
    checkXRBtn: $("#checkXRBtn"),
    startAR: $("#startAR"),

    // jury
    finalScore: $("#finalScore"),
    finalBar: $("#finalBar"),
    finalDecision: $("#finalDecision"),
    calcJury: $("#calcJury"),
    juryExport: $("#juryExport"),
    jConfidence: $("#jConfidence"),
    jVoice: $("#jVoice"),
    jAudience: $("#jAudience"),
    jBuild: $("#jBuild"),

    // analysis
    aWpm: $("#aWpm"),
    aConf: $("#aConf"),
    aFillers: $("#aFillers"),
    tips: $("#tips"),
    timeline: $("#timeline"),

    // data table
    sessionsTbl: $("#sessionsTbl"),
    refreshData: $("#refreshData"),

    // stage
    stageWrap: $("#stageWrap"),
    cam: $("#cam"),
    hud: $("#hud"),
    audience: $("#audience"),
    fx: $("#fx"),
    captions: $("#captions"),
    capText: $("#capText"),
    capBadge: $("#capBadge"),
    teleOverlay: $("#teleOverlay"),
    teleOverlayText: $("#teleOverlayText"),
    teleText: $("#teleText"),
    teleSpeed: $("#teleSpeed"),
    teleSize: $("#teleSize"),

    toggleMirror: $("#toggleMirror"),
    toggleAudience: $("#toggleAudience"),
    toggleTele: $("#toggleTele"),
    toggleHUD: $("#toggleHUD"),
    startSession: $("#startSession"),
    stopSession: $("#stopSession"),

    // stage text input
    teleInput: $("#teleText") ? null : null,
  };

  /* ---------- Core State ---------- */
  const state = {
    route: "demo",
    scenario: { name: "Ù‚Ø§Ø¹Ø© Ù…Ø¤ØªÙ…Ø±", env: "conference" },
    sessionRunning: false,
    startedAt: 0,
    timerId: null,
    tickId: null,

    // toggles
    showHUD: true,
    showAudience: true,
    showTele: false,
    mirror: false,

    // metrics
    wpm: 0,
    energy: 0,
    clarity: 0,
    audience: 0,
    confidence: 0,
    fillers: 0,
    tone: 0,

    // knobs
    pressure: 45,
    audienceSense: 55,
    coachMode: "soft",
    fxOn: true,
    ccOn: true,
    autoTele: false,

    // history (for timeline)
    samples: [],
  };

  /* ---------- Boot Overlay (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ---------- */
  function hideBoot() {
    const b = $("#bootOverlay");
    if (b) b.style.display = "none";
  }

  /* ---------- Storage ---------- */
  function loadSessions() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  }

  function saveSessions(list) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
  }

  function addSession(s) {
    const list = loadSessions();
    list.unshift(s);
    saveSessions(list);
    return list;
  }

  function wipeSessions() {
    localStorage.removeItem(STORAGE_KEY);
  }

  /* ---------- UI Utilities ---------- */
  function setStatus(txt, ok = true) {
    if (el.status) el.status.textContent = txt;
    if (el.dot) {
      el.dot.style.background = ok ? "var(--ok)" : "var(--warn)";
      el.dot.style.boxShadow = ok
        ? "0 0 0 6px rgba(33,230,164,.14)"
        : "0 0 0 6px rgba(255,206,58,.14)";
    }
  }

  function setBar(barEl, value01) {
    if (!barEl) return;
    barEl.style.width = `${clamp(value01, 0, 1) * 100}%`;
  }

  function fmtTime(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return `${m}:${s}`;
  }

  /* ---------- Router / Tabs ---------- */
  function go(route) {
    state.route = route;

    // tabs
    el.tabBtns.forEach((b) => b.classList.toggle("on", b.dataset.route === route));

    // views
    el.views.forEach((v) => v.classList.toggle("on", v.dataset.view === route));

    // update status
    const map = {
      demo: "Ø¬Ø§Ù‡Ø² â€¢ ÙˆØ¶Ø¹ Demo",
      webxr: "WebXR â€¢ ÙØ­Øµ Ø§Ù„Ø¯Ø¹Ù…",
      executive: "Executive Dashboard",
      settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
      jury: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙŠÙ…",
      analysis: "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡",
      data: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨",
      stage: "XR Stage",
    };
    setStatus(map[route] || "Ø¬Ø§Ù‡Ø²", true);

    // hash
    try {
      history.replaceState({}, "", `#${route}`);
    } catch {}
  }

  function initRouter() {
    // click
    el.tabBtns.forEach((b) => b.addEventListener("click", () => go(b.dataset.route)));

    // deep link
    const h = (location.hash || "").replace("#", "").trim();
    if (h) go(h);

    // stage quick
    if (el.goStageBtn) el.goStageBtn.addEventListener("click", () => go("stage"));
    if (el.goStage2) el.goStage2.addEventListener("click", () => go("stage"));
    if (el.goStage3) el.goStage3.addEventListener("click", () => go("stage"));
  }

  /* ---------- Scenario ---------- */
  function setScenario(name, env) {
    state.scenario = { name, env };
    setStatus(`Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ: ${name} â€¢ Ø¨ÙŠØ¦Ø©: ${env}`, true);

    // coach hint
    if (el.coachBox) {
      const hints = {
        "Ù…Ù‚Ø§Ø¨Ù„Ø©": "Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù‚ØµÙŠØ±Ø© (15â€“25 Ø«Ø§Ù†ÙŠØ©) Ù…Ø¹ Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø«Ø§Ø¨ØªØ©.",
        "Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±": "Ø³Ø±Ø¹Ø© Ù…ØªÙˆØ³Ø·Ø©ØŒ Ù†Ø¨Ø±Ø© Ø«Ø§Ø¨ØªØ©ØŒ Ù„Ø§ ØªÙƒØ«Ø± (ÙŠØ¹Ù†ÙŠ/Ø§Ù…Ù…Ù…).",
        "Ù‚Ø§Ø¹Ø© Ù…Ø¤ØªÙ…Ø±": "Ø§ÙØªØªØ§Ø­ÙŠØ© Ø®Ø·Ù‘Ø§ÙØ© + 3 Ù†Ù‚Ø§Ø· + Ø®Ø§ØªÙ…Ø© Ù‚ÙˆÙŠØ©.",
        "ØªÙ‚Ø±ÙŠØ± Ù…ÙŠØ¯Ø§Ù†ÙŠ": "ØµÙˆØª Ø£Ø¹Ù„Ù‰ 10%ØŒ ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ø§Ù„ØªÙØ§ØµÙŠÙ„.",
        "Ø¨ÙˆØ¯ÙƒØ§Ø³Øª": "Ø§Ø­ÙƒÙŠ Ù‚ØµØ© Ù‚ØµÙŠØ±Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… ØªØ´Ø¨ÙŠÙ‡Ø§ØªØŒ ÙˆØ®ÙÙ Ø§Ù„Ø±Ø³Ù…ÙŠØ§Øª.",
        "Ù‚Ø§Ø¹Ø© ØªØ¯Ø±ÙŠØ¨": "Ù‚Ø³Ù‘Ù… Ø§Ù„Ø´Ø±Ø­ Ø®Ø·ÙˆØ§Øª ÙˆØ§Ø¶Ø­Ø© Ù…Ø¹ Ø³Ø¤Ø§Ù„ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©.",
      };
      el.coachBox.textContent = hints[name] || "Ø¬Ø§Ù‡Ø²â€¦";
    }
  }

  function initScenarios() {
    el.scenarioBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        setScenario(btn.dataset.sc, btn.dataset.env);
      });
    });

    if (el.pickScenarioBtn) {
      el.pickScenarioBtn.addEventListener("click", () => {
        const all = [
          ["Ù…Ù‚Ø§Ø¨Ù„Ø©", "conference"],
          ["Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±", "studio"],
          ["Ù‚Ø§Ø¹Ø© Ù…Ø¤ØªÙ…Ø±", "conference"],
          ["ØªÙ‚Ø±ÙŠØ± Ù…ÙŠØ¯Ø§Ù†ÙŠ", "outdoor"],
          ["Ø¨ÙˆØ¯ÙƒØ§Ø³Øª", "podcast"],
          ["Ù‚Ø§Ø¹Ø© ØªØ¯Ø±ÙŠØ¨", "studio"],
        ];
        const pick = all[Math.floor(Math.random() * all.length)];
        setScenario(pick[0], pick[1]);
      });
    }
  }

  /* ---------- Start/Stop ALL ---------- */
  function startAll() {
    if (state.sessionRunning) return;
    go("stage");
    startSession();
  }

  function stopAll() {
    stopSession();
  }

  function initTopActions() {
    if (el.startAll) el.startAll.addEventListener("click", startAll);
    if (el.stopAll) el.stopAll.addEventListener("click", stopAll);
  }

  /* ---------- Settings ---------- */
  function initSettings() {
    if (el.pressure) {
      state.pressure = Number(el.pressure.value || 45);
      el.pressure.addEventListener("input", () => (state.pressure = Number(el.pressure.value)));
    }
    if (el.audienceSense) {
      state.audienceSense = Number(el.audienceSense.value || 55);
      el.audienceSense.addEventListener("input", () => (state.audienceSense = Number(el.audienceSense.value)));
    }
    if (el.autoTele) {
      state.autoTele = !!el.autoTele.checked;
      el.autoTele.addEventListener("change", () => (state.autoTele = !!el.autoTele.checked));
    }
    if (el.fxOn) {
      state.fxOn = !!el.fxOn.checked;
      el.fxOn.addEventListener("change", () => (state.fxOn = !!el.fxOn.checked));
    }
    if (el.ccOn) {
      state.ccOn = !!el.ccOn.checked;
      el.ccOn.addEventListener("change", () => (state.ccOn = !!el.ccOn.checked));
    }

    // coach mode seg
    if (el.coachModeSeg) {
      const btns = $$("button", el.coachModeSeg);
      btns.forEach((b) => {
        b.addEventListener("click", () => {
          btns.forEach((x) => x.classList.remove("on"));
          b.classList.add("on");
          state.coachMode = b.dataset.mode || "soft";
          setStatus(`Ù†Ù…Ø· Ø§Ù„Ù…Ø¯Ø±Ø¨: ${state.coachMode}`, true);
        });
      });
    }
  }

  /* ---------- WebXR (ÙØ­Øµ Ø¨Ø³ÙŠØ·) ---------- */
  async function checkXR() {
    if (!el.xrSupport) return;
    try {
      const xr = navigator.xr;
      if (!xr) {
        el.xrSupport.textContent = "ØºÙŠØ± Ù…ØªØ§Ø­ (navigator.xr ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)";
        return;
      }
      const ok = await xr.isSessionSupported("immersive-ar");
      el.xrSupport.textContent = ok ? "Ù…Ø¯Ø¹ÙˆÙ… âœ… (immersive-ar)" : "ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… âŒ";
    } catch (e) {
      el.xrSupport.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ­Øµ";
    }
  }

  function initWebXR() {
    if (el.checkXRBtn) el.checkXRBtn.addEventListener("click", checkXR);
    if (el.startAR) el.startAR.addEventListener("click", () => {
      // Ù„Ø§ Ù†ÙØªØ­ Ø¬Ù„Ø³Ø© XR Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§ (Ø¨Ø³Ø¨Ø¨ iOS)ØŒ Ù„ÙƒÙ† Ù†Ø¹Ø·ÙŠ Ø¥Ø­Ø³Ø§Ø³ "ØªØ´ØºÙŠÙ„"
      setStatus("AR: ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„ÙˆØ¶Ø¹ XR Demo", true);
      go("stage");
      state.showHUD = true;
      state.showAudience = true;
      state.showTele = true;
      syncStageToggles();
    });
  }

  /* ---------- Stage Toggles ---------- */
  function syncStageToggles() {
    // HUD
    if (el.hud) el.hud.style.display = state.showHUD ? "block" : "none";

    // Audience canvas layer (we use canvas in HTML; but visuals are drawn)
    if (el.audience) el.audience.style.display = state.showAudience ? "block" : "none";

    // Tele overlay
    if (el.teleOverlay) el.teleOverlay.style.display = state.showTele ? "flex" : "none";

    // Captions
    if (el.captions) el.captions.style.display = state.ccOn ? "flex" : "none";

    // FX
    if (el.fx) el.fx.style.display = state.fxOn ? "block" : "none";
  }

  function initStageButtons() {
    if (el.toggleHUD) el.toggleHUD.addEventListener("click", () => { state.showHUD = !state.showHUD; syncStageToggles(); });
    if (el.toggleAudience) el.toggleAudience.addEventListener("click", () => { state.showAudience = !state.showAudience; syncStageToggles(); });
    if (el.toggleTele) el.toggleTele.addEventListener("click", () => { state.showTele = !state.showTele; syncStageToggles(); });
    if (el.toggleMirror) el.toggleMirror.addEventListener("click", () => {
      state.mirror = !state.mirror;
      if (el.cam) el.cam.style.transform = state.mirror ? "scaleX(-1)" : "none";
      setStatus(state.mirror ? "Ù…Ø±Ø¢Ø©: ON" : "Ù…Ø±Ø¢Ø©: OFF", true);
    });

    if (el.startSession) el.startSession.addEventListener("click", startSession);
    if (el.stopSession) el.stopSession.addEventListener("click", stopSession);
  }

  /* ---------- Camera (Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¥Ø°Ø§ ÙØ´Ù„ Ù†Ø­Ø§ÙƒÙŠ) ---------- */
  async function tryStartCamera() {
    if (!el.cam) return false;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false,
      });
      el.cam.srcObject = stream;
      return true;
    } catch {
      // no camera / not https / permission denied
      return false;
    }
  }

  function stopCamera() {
    if (!el.cam || !el.cam.srcObject) return;
    const s = el.cam.srcObject;
    try {
      s.getTracks().forEach((t) => t.stop());
    } catch {}
    el.cam.srcObject = null;
  }

  /* ---------- Metrics Engine (Mock â€œØ­Ù‚ÙŠÙ‚ÙŠâ€ Ø¨Ø§Ù„Ø¥Ø­Ø³Ø§Ø³) ---------- */
  function computeMetrics() {
    // pressure influences volatility
    const p = state.pressure / 100;

    // scenario baseline
    const base = {
      "Ù…Ù‚Ø§Ø¨Ù„Ø©": { w: 145, e: 58, c: 72, a: 60 },
      "Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±": { w: 155, e: 52, c: 78, a: 58 },
      "Ù‚Ø§Ø¹Ø© Ù…Ø¤ØªÙ…Ø±": { w: 140, e: 66, c: 74, a: 70 },
      "ØªÙ‚Ø±ÙŠØ± Ù…ÙŠØ¯Ø§Ù†ÙŠ": { w: 165, e: 72, c: 68, a: 62 },
      "Ø¨ÙˆØ¯ÙƒØ§Ø³Øª": { w: 130, e: 60, c: 80, a: 65 },
      "Ù‚Ø§Ø¹Ø© ØªØ¯Ø±ÙŠØ¨": { w: 135, e: 62, c: 76, a: 68 },
    }[state.scenario.name] || { w: 145, e: 60, c: 75, a: 65 };

    // wpm target + noise
    const wpm = clamp(Math.round(base.w + rnd(-18, 18) * (0.6 + p)), 90, 200);
    const energy = clamp(Math.round(base.e + rnd(-18, 18) * (0.7 + p)), 10, 100);
    const clarity = clamp(Math.round(base.c + rnd(-14, 14) * (0.6 + p)), 10, 100);

    // audience responds to energy + clarity and sensitivity
    const sense = state.audienceSense / 100;
    let audience = base.a + (energy - 55) * 0.35 + (clarity - 70) * 0.28 + rnd(-10, 10) * sense;
    audience = clamp(Math.round(audience), 0, 100);

    // derived
    const confidence = clamp(Math.round((clarity * 0.55 + energy * 0.35 + audience * 0.25) / 1.15), 0, 100);
    const fillers = clamp(Math.round((100 - clarity) * 0.18 + rnd(0, 8) + p * 6), 0, 25);
    const tone = clamp(Math.round((energy * 0.6 + clarity * 0.4) / 1.0 + rnd(-6, 6)), 0, 100);

    state.wpm = wpm;
    state.energy = energy;
    state.clarity = clarity;
    state.audience = audience;
    state.confidence = confidence;
    state.fillers = fillers;
    state.tone = tone;

    // sample for timeline
    state.samples.push({
      t: Math.floor((Date.now() - state.startedAt) / 1000),
      wpm, energy, confidence,
    });
    if (state.samples.length > 220) state.samples.shift();
  }

  /* ---------- HUD update ---------- */
  function updateHUD() {
    // mini stats cards
    if (el.wpmV) el.wpmV.textContent = state.wpm ? String(state.wpm) : "â€”";
    if (el.enV) el.enV.textContent = state.energy ? `${state.energy}%` : "â€”";
    if (el.clV) el.clV.textContent = state.clarity ? `${state.clarity}%` : "â€”";
    if (el.auV) el.auV.textContent = state.audience ? `${state.audience}%` : "â€”";

    setBar(el.wpmBar, (state.wpm - 90) / (200 - 90));
    setBar(el.enBar, state.energy / 100);
    setBar(el.clBar, state.clarity / 100);
    setBar(el.auBar, state.audience / 100);

    // last report mini (live snapshot)
    if (el.rScore) el.rScore.textContent = computeFinalScore().toFixed(0);
    if (el.rDecision) el.rDecision.textContent = computeDecision();
    if (el.rSummary) el.rSummary.textContent = coachSummary();
    if (el.rCount) el.rCount.textContent = String(loadSessions().length);

    // KPIs
    const list = loadSessions();
    if (el.kpiSessions) el.kpiSessions.textContent = String(list.length);
    if (el.exSessions) el.exSessions.textContent = String(list.length);
    if (el.rCount) el.rCount.textContent = String(list.length);

    const best = list.reduce((m, s) => Math.max(m, s.score || 0), 0);
    if (el.kpiBest) el.kpiBest.textContent = best ? String(best) : "â€”";
    if (el.exBest) el.exBest.textContent = best ? String(best) : "â€”";
    if (el.kpiReady) el.kpiReady.textContent = best >= 82 ? "Ready" : "Training";

    if (el.exLast) el.exLast.textContent = list[0]?.scenario || "â€”";
    if (el.exReady) el.exReady.textContent = best >= 82 ? "Ready âœ…" : "Needs polish";

    if (el.execText) el.execText.textContent = executiveText();

    // coach box live
    if (el.coachBox && state.sessionRunning) el.coachBox.textContent = coachLine();

    // captions
    if (el.capText && state.ccOn && state.sessionRunning) el.capText.textContent = captionsLine();
  }

  /* ---------- Coach / Captions ---------- */
  function coachLine() {
    const mode = state.coachMode;
    const weak = [];
    if (state.wpm > 170) weak.push("Ø®ÙÙ‘Ù Ø§Ù„Ø³Ø±Ø¹Ø© Ø´ÙˆÙŠ");
    if (state.wpm < 110) weak.push("Ø§Ø±ÙØ¹ Ø§Ù„Ø³Ø±Ø¹Ø© Ø´ÙˆÙŠ");
    if (state.fillers > 10) weak.push("Ù‚Ù„Ù‘Ù„ (ÙŠØ¹Ù†ÙŠ/Ø§Ù…Ù…Ù…)");
    if (state.clarity < 65) weak.push("ÙˆØ¶Ù‘Ø­ Ø§Ù„Ø¬Ù…Ù„ ÙˆØ®ÙÙ Ø§Ù„ØªØ´ØªØª");
    if (state.energy < 45) weak.push("Ø§Ø±ÙØ¹ Ø§Ù„Ø·Ø§Ù‚Ø© + Ù†Ø¨Ø±Ø©");
    if (state.audience < 55) weak.push("Ø£Ø¶Ù Ù‚ØµØ©/Ù…Ø«Ø§Ù„ ÙŠØ¹ÙŠØ¯ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±");

    const best = [];
    if (state.clarity >= 78) best.push("ÙˆØ¶ÙˆØ­ Ù…Ù…ØªØ§Ø²");
    if (state.confidence >= 78) best.push("Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©");
    if (state.audience >= 72) best.push("Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù…ØªÙØ§Ø¹Ù„");

    const n = weak.length ? weak[0] : "Ø§Ø³ØªÙ…Ø±â€¦ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø«Ø§Ø¨Øª";
    const b = best.length ? ` â€¢ âœ… ${best[0]}` : "";

    if (mode === "jury") return `ğŸ§‘â€âš–ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ø¬Ù†Ø©: ${n}.${b}`;
    if (mode === "direct") return `ğŸ¯ ØªØ¹Ø¯ÙŠÙ„ ÙÙˆØ±ÙŠ: ${n}.${b}`;
    return `ğŸ¤ Ù…Ù…ØªØ§Ø²â€¦ ${n}.${b}`;
  }

  function coachSummary() {
    const score = computeFinalScore();
    if (score >= 88) return "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù…ÙŠ (Ù…Ø³ØªÙˆÙ‰ Ù…Ø¨Ù‡Ø±)";
    if (score >= 80) return "Ù‚ÙˆÙŠ Ø¬Ø¯Ù‹Ø§â€¦ ÙŠØ­ØªØ§Ø¬ Ù„Ù…Ø³Ø© Ø¥ÙŠÙ‚Ø§Ø¹/Ø­Ø´ÙˆÙŠØ©";
    if (score >= 70) return "Ø¬ÙŠØ¯â€¦ ÙŠØ­ØªØ§Ø¬ ÙˆØ¶ÙˆØ­ + Ø¨Ù†Ø§Ø¡ Ø£Ù‚ÙˆÙ‰";
    return "Ø§Ø¨Ø¯Ø£ Ø¨ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙÙƒØ±Ø© Ø¥Ù„Ù‰ 3 Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø©";
  }

  function captionsLine() {
    const s = state.scenario.name;
    const hints = [
      `(${s}) Ø§ÙØªØªØ­ Ø¨Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø®Ø·Ù‘Ø§ÙØ©â€¦ Ø«Ù… Ø§Ø¯Ø®Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.`,
      `Ø®ÙÙ‘Ù Ø§Ù„Ø³Ø±Ø¹Ø© 5% ÙˆØ®Ù„Ùƒ ÙˆØ§Ø¶Ø­: (ÙÙƒØ±Ø© â†’ Ø¯Ù„ÙŠÙ„ â†’ Ù†ØªÙŠØ¬Ø©).`,
      `Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± ÙŠØ¨ØºÙ‰ Ù…Ø«Ø§Ù„â€¦ Ø¹Ø·Ù‡Ù… Ù…Ø«Ø§Ù„ ÙˆØ§Ù‚Ø¹ÙŠ ÙÙŠ 10 Ø«ÙˆØ§Ù†ÙŠ.`,
      `Ù†Ø¨Ø±Ø© Ù…Ù…ØªØ§Ø²Ø©â€¦ Ø§Ù„Ø¢Ù† Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø®Ø§ØªÙ…Ø© Ø¨Ù‚Ø±Ø§Ø± ÙˆØ§Ø¶Ø­.`,
    ];
    return hints[Math.floor(Math.random() * hints.length)];
  }

  /* ---------- Scoring / Decision ---------- */
  function computeFinalScore() {
    // weighting
    const wpmScore = 100 - clamp(Math.abs(state.wpm - 145) * 0.8, 0, 35);
    const score =
      wpmScore * 0.18 +
      state.clarity * 0.30 +
      state.energy * 0.18 +
      state.audience * 0.22 +
      state.confidence * 0.20 -
      state.fillers * 0.7;

    return clamp(score, 0, 100);
  }

  function computeDecision() {
    const score = computeFinalScore();
    if (score >= 88) return "âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ ÙÙˆØ±ÙŠ";
    if (score >= 80) return "âœ… Ù…Ù…ØªØ§Ø² â€” Ø¬Ø§Ù‡Ø² Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø¨Ø³ÙŠØ·";
    if (score >= 70) return "âš ï¸ Ø¬ÙŠØ¯ â€” ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø±ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ";
    return "âŒ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡";
  }

  /* ---------- FX Canvas ---------- */
  function fxResize() {
    if (!el.fx) return;
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = el.fx.getBoundingClientRect();
    el.fx.width = Math.floor(r.width * dpr);
    el.fx.height = Math.floor(r.height * dpr);
  }

  const fx = {
    parts: [],
    last: 0,
  };

  function fxInit() {
    if (!el.fx) return;
    fxResize();
    fx.parts = Array.from({ length: 70 }, () => ({
      x: Math.random(),
      y: Math.random(),
      vx: rnd(-0.015, 0.015),
      vy: rnd(-0.02, -0.005),
      s: rnd(0.6, 2.0),
      o: rnd(0.12, 0.45),
    }));
    fx.last = performance.now();
    requestAnimationFrame(fxTick);
  }

  function fxTick(ts) {
    if (!el.fx) return;
    const ctx = el.fx.getContext("2d");
    if (!ctx) return;

    const dt = Math.min(32, ts - fx.last);
    fx.last = ts;

    // clear
    ctx.clearRect(0, 0, el.fx.width, el.fx.height);

    if (!state.fxOn || !state.sessionRunning) {
      requestAnimationFrame(fxTick);
      return;
    }

    // energy affects intensity
    const intensity = clamp(state.energy / 100, 0.2, 1);

    // draw
    const w = el.fx.width;
    const h = el.fx.height;

    // subtle glow wash
    ctx.globalAlpha = 0.12 * intensity;
    const grd = ctx.createRadialGradient(w * 0.55, h * 0.35, 10, w * 0.55, h * 0.35, Math.max(w, h) * 0.6);
    grd.addColorStop(0, "rgba(124,92,255,.9)");
    grd.addColorStop(0.55, "rgba(33,230,164,.55)");
    grd.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, w, h);

    // particles
    fx.parts.forEach(p => {
      p.x += p.vx * (dt / 16) * (0.8 + intensity);
      p.y += p.vy * (dt / 16) * (0.8 + intensity);

      if (p.y < -0.05) { p.y = 1.05; p.x = Math.random(); }
      if (p.x < -0.05) p.x = 1.05;
      if (p.x > 1.05) p.x = -0.05;

      const px = p.x * w;
      const py = p.y * h;

      ctx.globalAlpha = p.o * intensity;
      ctx.beginPath();
      ctx.arc(px, py, p.s * (1 + intensity * 0.8), 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.fill();

      // trailing glow
      ctx.globalAlpha = p.o * 0.35 * intensity;
      ctx.beginPath();
      ctx.arc(px, py, p.s * 5.5 * intensity, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(124,92,255,.35)";
      ctx.fill();
    });

    requestAnimationFrame(fxTick);
  }

  /* ---------- Audience Canvas ---------- */
  function audienceResize() {
    if (!el.audience) return;
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = el.audience.getBoundingClientRect();
    el.audience.width = Math.floor(r.width * dpr);
    el.audience.height = Math.floor(r.height * dpr);
  }

  function drawAudience() {
    if (!el.audience) return;
    const ctx = el.audience.getContext("2d");
    if (!ctx) return;

    const w = el.audience.width;
    const h = el.audience.height;

    ctx.clearRect(0, 0, w, h);

    if (!state.showAudience || !state.sessionRunning) return;

    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));

    // audience intensity
    const a = state.audience / 100;
    const rows = 10;
    const cols = 18;

    const cellW = w / cols;
    const cellH = h / rows;

    ctx.save();
    ctx.globalAlpha = 0.9;

   
