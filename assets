/* ===============================
   SpeakXR X-Stage PRO (Static)
   assets/app.js
   =============================== */

const $ = (s, r = document) => r.querySelector(s);
const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

/* ---------- Router (Tabs) ---------- */
function go(page) {
  const id = `page-${page}`;
  $$(".page").forEach((p) => p.classList.remove("active"));
  const target = document.getElementById(id);
  if (target) target.classList.add("active");

  // highlight nav
  $$(".navBtn").forEach((b) => {
    if (b.dataset.go) b.classList.toggle("active", b.dataset.go === page);
  });

  // keep hash
  history.replaceState({}, "", `#${page}`);
}

function initRouter() {
  // buttons with data-go
  $$(".navBtn").forEach((btn) => {
    if (!btn.dataset.go) return;
    btn.addEventListener("click", () => go(btn.dataset.go));
  });

  const initial = (location.hash || "#home").slice(1);
  go(initial);

  window.addEventListener("hashchange", () => {
    const p = (location.hash || "#home").slice(1);
    go(p);
  });
}

/* ---------- Elements ---------- */
const els = {
  // session
  startBtn: $("#startBtn"),
  stopBtn: $("#stopBtn"),
  themeBtn: $("#themeBtn"),

  // toggles
  toggleHUD: $("#toggleHUD"),
  toggleAudience: $("#toggleAudience"),
  toggleTele: $("#toggleTele"),
  toggleVR: $("#toggleVR"),

  // sliders
  hudSize: $("#hudSize"),
  audPower: $("#audPower"),
  teleSpeed: $("#teleSpeed"),

  // stage
  pillMode: $("#pillMode"),
  pillAud: $("#pillAud"),
  pillHud: $("#pillHud"),
  pillTime: $("#pillTime"),

  hudHint: $("#hudHint"),
  tele: $("#tele"),
  teleText: $("#teleText"),
  lens: $("#lens"),

  audience: $("#audience"),
  audGrid: $("#audGrid"),

  vr: $("#vr"),

  // script
  scriptInput: $("#scriptInput"),
  applyScript: $("#applyScript"),
  wowBtn: $("#wowBtn"),

  // status
  dot: $("#dot"),
  stTitle: $("#stTitle"),
  stSub: $("#stSub"),

  // KPIs
  kWpm: $("#kWpm"),
  kConf: $("#kConf"),
  kFill: $("#kFill"),
  kTone: $("#kTone"),

  // XR page
  xrHud: $("#xrHud"),
  xrAud: $("#xrAud"),
  xrTele: $("#xrTele"),
  xrVr: $("#xrVr"),
  bClap: $("#bClap"),
  bFocus: $("#bFocus"),
  bDis: $("#bDis"),
  randBars: $("#randBars"),
  teleArea: $("#teleArea"),
  teleApply: $("#teleApply"),
  miniOut: $("#miniOut"),
  pokeCoach: $("#pokeCoach"),

  // Coach
  chat: $("#chat"),
  chatInput: $("#chatInput"),
  sendChat: $("#sendChat"),

  // Judge
  sClarity: $("#sClarity"),
  sStab: $("#sStab"),
  sEng: $("#sEng"),
  sLang: $("#sLang"),
  calcJudge: $("#calcJudge"),
  finalScore: $("#finalScore"),
  decision: $("#decision"),
  makeReport: $("#makeReport"),
  copyReport: $("#copyReport"),
  report: $("#report"),

  // Reports
  saveSession: $("#saveSession"),
  sessions: $("#sessions"),
  clearSessions: $("#clearSessions"),
};

/* ---------- Safety: if element missing ---------- */
function must(el, name) {
  if (!el) console.warn("Missing element:", name);
  return el;
}
Object.entries(els).forEach(([k, v]) => must(v, k));

/* ---------- State ---------- */
const state = {
  sessionOn: false,
  hudOn: true,
  audOn: false,
  teleOn: false,
  vrOn: false,

  t: 0,
  tickTimer: null,
  teleTimer: null,

  // metrics
  wpm: 0,
  conf: 0,
  filler: 0,
  tone: 0,

  // audience mood
  audPower: 60,

  // tele
  telePos: 0,
};

/* ---------- Helpers ---------- */
function fmt(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${m}:${s}`;
}

function clamp(n, a, b) {
  return Math.max(a, Math.min(b, n));
}

function rand(a, b) {
  return Math.floor(Math.random() * (b - a + 1)) + a;
}

function setStatus(mode, title, sub) {
  // mode: ok|warn|bad
  const color =
    mode === "ok" ? "var(--ok)" : mode === "bad" ? "var(--bad)" : "var(--warn)";
  if (els.dot) {
    els.dot.style.background = color;
    els.dot.style.boxShadow =
      mode === "ok"
        ? "0 0 0 6px rgba(33,230,164,.14)"
        : mode === "bad"
        ? "0 0 0 6px rgba(255,77,109,.14)"
        : "0 0 0 6px rgba(255,206,58,.14)";
  }
  if (els.stTitle) els.stTitle.textContent = title;
  if (els.stSub) els.stSub.textContent = sub;
}

/* ---------- Audience Engine ---------- */
function buildAudience(power = 60) {
  if (!els.audGrid) return;

  els.audGrid.innerHTML = "";
  const cols = 10;
  const total = clamp(power, 20, 120);
  const rows = Math.ceil(total / cols);

  els.audGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

  for (let i = 0; i < rows * cols; i++) {
    const sp = document.createElement("span");
    sp.style.opacity = (Math.random() * 0.45 + 0.35).toFixed(2);
    els.audGrid.appendChild(sp);
  }
}

function updateAudienceMood() {
  if (!els.audGrid) return;

  const power = state.audPower;
  if (els.pillAud) els.pillAud.textContent = `AUD: ${power}`;

  const nodes = $$("#audGrid span");
  nodes.forEach((sp) => {
    const r = Math.random() * 100;
    const on = r < power;
    sp.style.opacity = on ? "0.95" : "0.35";
    sp.style.transform = on ? "translateY(-1px)" : "none";
  });

  // audience also influences confidence slightly
  state.conf = clamp(state.conf + (power > 70 ? 1 : -1), 0, 100);
}

/* ---------- Teleprompter ---------- */
function setTeleText(text) {
  const t = (text || "").trim();
  if (els.teleText) els.teleText.textContent = t || "Ø§ÙƒØªØ¨ Ù†ØµÙƒ ØªØ­Øªâ€¦ Ø«Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Øµ.";
}

function startTeleScroll() {
  stopTeleScroll();
  state.telePos = 0;

  const speed = () => Number(els.teleSpeed?.value || 70);
  state.teleTimer = setInterval(() => {
    if (!state.sessionOn || !state.teleOn) return;
    // move telePos
    state.telePos += Math.max(1, Math.floor(speed() / 30));
    // simulate scrolling by changing hint area / simple transform
    if (els.teleText) {
      els.teleText.style.transform = `translateY(-${Math.min(state.telePos, 120)}px)`;
    }
    if (state.telePos > 220) state.telePos = 0;
  }, 220);
}

function stopTeleScroll() {
  if (state.teleTimer) clearInterval(state.teleTimer);
  state.teleTimer = null;
  if (els.teleText) els.teleText.style.transform = "translateY(0)";
}

/* ---------- HUD ---------- */
function setHudSize(px) {
  const v = Number(px || 18);
  if (els.lens) els.lens.style.fontSize = `${v}px`;
}

function hudHint(msg) {
  if (!els.hudHint) return;
  els.hudHint.textContent = msg;
}

/* ---------- WOW Demo (Particles-ish + glow pulse) ---------- */
function wowPulse() {
  if (!els.lens) return;
  els.lens.animate(
    [
      { transform: "scale(1)", filter: "saturate(1)" },
      { transform: "scale(1.01)", filter: "saturate(1.15)" },
      { transform: "scale(1)", filter: "saturate(1)" },
    ],
    { duration: 850, easing: "ease-in-out" }
  );
}

/* ---------- Metrics (Mock realistic) ---------- */
function computeMetricsTick() {
  // WPM baseline 120-160
  const base = 140 + rand(-18, 18);
  state.wpm = clamp(base + (state.sessionOn ? rand(-10, 10) : 0), 90, 210);

  // filler increases when wpm too high or confidence low
  const tooFast = state.wpm > 170 ? 1 : 0;
  state.filler = clamp(state.filler + rand(-1, 2) + tooFast, 0, 30);

  // tone (0-100) affected by confidence
  state.tone = clamp(50 + Math.floor(state.conf / 2) + rand(-10, 10), 0, 100);

  // confidence evolves
  state.conf = clamp(state.conf + rand(-2, 3) - (tooFast ? 1 : 0), 0, 100);

  // update KPIs
  if (els.kWpm) els.kWpm.textContent = String(state.wpm);
  if (els.kConf) els.kConf.textContent = `${state.conf}%`;
  if (els.kFill) els.kFill.textContent = String(state.filler);
  if (els.kTone) els.kTone.textContent = String(state.tone);

  // update pills
  if (els.pillMode) els.pillMode.textContent = state.sessionOn ? "MODE: LIVE" : "MODE: READY";
  if (els.pillHud) els.pillHud.textContent = `HUD: ${state.hudOn ? "ON" : "OFF"}`;

  // dynamic hints
  if (state.wpm > 170) hudHint("Ø³Ø±Ø¹ØªÙƒ Ø¹Ø§Ù„ÙŠØ©â€¦ Ø®Ø° Ù†ÙØ³ ÙˆØ®ÙÙ‘Ù 10% ğŸ¯");
  else if (state.filler > 14) hudHint("Ù‚Ù„Ù‘Ù„: (ÙŠØ¹Ù†ÙŠ/Ø§Ù…Ù…Ù…)â€¦ Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø³ÙƒØªØ© Ù‚ØµÙŠØ±Ø© âœ¨");
  else if (state.conf < 35) hudHint("Ø«Ø¨Ù‘Øª Ù†Ø¸Ø±Ùƒ Ù„Ù„Ø£Ù…Ø§Ù…â€¦ ÙˆØªÙƒÙ„Ù… Ø¨Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø© Ù‚ÙˆÙŠØ© ğŸ’ª");
  else hudHint("Ù…Ù…ØªØ§Ø²â€¦ ÙƒÙ…Ù‘Ù„ Ø¨Ù†ÙØ³ Ø§Ù„Ù†Ø³Ù‚ ğŸ”¥");
}

/* ---------- Session Controls ---------- */
function startSession() {
  if (state.sessionOn) return;
  state.sessionOn = true;
  state.t = 0;

  setStatus("ok", "Ø¬Ù„Ø³Ø© Ø´ØºØ§Ù„Ø©", "HUD + Ù…Ø­Ø§ÙƒØ§Ø© XR ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†");
  if (els.startBtn) els.startBtn.disabled = true;
  if (els.stopBtn) els.stopBtn.disabled = false;

  // start tick
  if (state.tickTimer) clearInterval(state.tickTimer);
  state.tickTimer = setInterval(() => {
    state.t++;
    if (els.pillTime) els.pillTime.textContent = fmt(state.t);
    computeMetricsTick();
    if (state.audOn) updateAudienceMood();
  }, 1000);

  // tele
  if (state.teleOn) startTeleScroll();

  // wow
  wowPulse();
}

function stopSession() {
  if (!state.sessionOn) return;
  state.sessionOn = false;

  setStatus("warn", "ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù", "ØªÙ‚Ø¯Ø± ØªØ­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø£Ùˆ ØªÙˆÙ„Ù‘Ø¯ ØªÙ‚Ø±ÙŠØ±");
  if (els.startBtn) els.startBtn.disabled = false;
  if (els.stopBtn) els.stopBtn.disabled = true;

  if (state.tickTimer) clearInterval(state.tickTimer);
  state.tickTimer = null;

  stopTeleScroll();
}

/* ---------- Toggles ---------- */
function toggleHUD() {
  state.hudOn = !state.hudOn;
  if (els.hud) els.hud.style.display = state.hudOn ? "block" : "none";
  setStatus("ok", state.hudOn ? "HUD Ø´ØºØ§Ù„" : "HUD Ù…Ù‚ÙÙˆÙ„", "ØªÙ‚Ø¯Ø± ØªÙØªØ­Ù‡ Ø¨Ø£ÙŠ ÙˆÙ‚Øª");
  wowPulse();
}

function toggleAudience() {
  state.audOn = !state.audOn;
  if (els.audience) els.audience.style.display = state.audOn ? "block" : "none";
  if (state.audOn) {
    buildAudience(state.audPower);
    updateAudienceMood();
    setStatus("ok", "Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø´ØºØ§Ù„", "Ù…Ø²Ø§Ø¬Ù‡ ÙŠØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ˜„");
  } else {
    setStatus("ok", "Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù…Ù‚ÙÙˆÙ„", "Ø®ÙÙ‘ Ø§Ù„ØªÙˆØªØ±â€¦ Ù…Ø§ Ø£Ø­Ø¯ ÙŠØ·Ø§Ù„Ø¹ ğŸ¤");
  }
  wowPulse();
}

function toggleTele() {
  state.teleOn = !state.teleOn;
  if (els.tele) els.tele.style.display = state.teleOn ? "block" : "none";
  if (state.teleOn) {
    startTeleScroll();
    setStatus("ok", "Ø§Ù„ØªÙ„Ù‚ÙŠÙ† Ø´ØºØ§Ù„", "Ø§Ù„Ø³Ø±Ø¹Ø© Ù…Ù† Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±");
  } else {
    stopTeleScroll();
    setStatus("ok", "Ø§Ù„ØªÙ„Ù‚ÙŠÙ† Ù…Ù‚ÙÙˆÙ„", "ØªÙ‚Ø¯Ø± ØªØ±Ø¬Ø¹ Ù„Ù‡");
  }
  wowPulse();
}

function toggleVR() {
  state.vrOn = !state.vrOn;
  if (els.vr) els.vr.style.display = state.vrOn ? "block" : "none";
  setStatus("ok", state.vrOn ? "VR Concept ON" : "VR Concept OFF", "Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¯ÙˆÙ† Ù†Ø¸Ø§Ø±Ø©");
  wowPulse();
}

/* ---------- XR page extras ---------- */
function randomizeBars() {
  const a = rand(15, 100);
  const b = rand(15, 100);
  const c = rand(15, 100);
  if (els.bClap) els.bClap.style.transform = `scaleX(${a / 100})`;
  if (els.bFocus) els.bFocus.style.transform = `scaleX(${b / 100})`;
  if (els.bDis) els.bDis.style.transform = `scaleX(${c / 100})`;
  if (els.miniOut) els.miniOut.textContent = `ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±: ØªØµÙÙŠÙ‚ ${a}% â€¢ ØªØ±ÙƒÙŠØ² ${b}% â€¢ ØªØ´ØªØª ${c}%`;
}

/* ---------- Coach (Mock smart) ---------- */
function pushChat(text, who = "bot") {
  if (!els.chat) return;
  const div = document.createElement("div");
  div.className = `msg ${who}`;
  div.textContent = text;
  els.chat.appendChild(div);
  els.chat.scrollTop = els.chat.scrollHeight;
}

function coachAnswer(q) {
  const s = (q || "").toLowerCase();

  if (s.includes("Ù…Ù‚Ø¯Ù…Ø©") || s.includes("Ø§Ø¨Ø¯Ø£") || s.includes("Ø§ÙØªØªØ§Ø­")) {
    return "Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ù…Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚ÙˆÙŠØ© + ØªÙˆÙ‚Ù Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©. Ù…Ø«Ø§Ù„: (Ø§Ù„ÙŠÙˆÙ…â€¦ Ø±Ø§Ø­ Ø£ÙˆØ±ÙŠÙƒÙ… ÙƒÙŠÙ ØªØªØ­ÙˆÙ„ Ø§Ù„Ø«Ù‚Ø© Ø¥Ù„Ù‰ Ø£Ø¯Ø§Ø¡). Ø«Ù… Ø§Ø¯Ø®Ù„ Ø¹Ù„Ù‰ 3 Ù†Ù‚Ø§Ø· ÙˆØ§Ø¶Ø­Ø©.";
  }
  if (s.includes("ØªÙˆØªØ±") || s.includes("Ø®ÙˆÙ") || s.includes("Ø§Ø±ØªØ¨Ø§Ùƒ")) {
    return "Ù‚Ø§Ø¹Ø¯Ø© Ø°Ù‡Ø¨ÙŠØ©: Ù†ÙØ³ Ø¹Ù…ÙŠÙ‚ 4 Ø«ÙˆØ§Ù†ÙŠØŒ Ø«Ù… Ø¬Ù…Ù„Ø© Ù‚ØµÙŠØ±Ø©. Ù„Ø§ ØªÙƒØ«Ø± ØªÙØ§ØµÙŠÙ„. Ø®Ù„ÙŠ Ø¹ÙŠÙ†Ùƒ Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø«Ø§Ø¨ØªØ© ÙÙˆÙ‚ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±.";
  }
  if (s.includes("Ø³Ø±Ø¹Ø©") || s.includes("wpm")) {
    return "Ù‡Ø¯ÙÙƒ 120â€“160 ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©. Ø¥Ø°Ø§ ØªØ¹Ø¯ÙŠØª 170: Ø§Ù‚Ø³Ù… Ø§Ù„ÙÙƒØ±Ø© Ù„Ø¬Ù…Ù„ØªÙŠÙ†ØŒ ÙˆØ®Ø° Ø³ÙƒØªØ© Ø¨Ø¯Ù„ (Ø§Ù…Ù…Ù…).";
  }
  if (s.includes("ØªØ­ÙƒÙŠÙ…") || s.includes("Ø¯Ø±Ø¬Ø§Øª") || s.includes("Ù„Ø¬Ù†Ø©")) {
    return "Ø±ÙƒØ² Ø¹Ù„Ù‰: ÙˆØ¶ÙˆØ­ (ØªØ±ØªÙŠØ¨)ØŒ Ø«Ø¨Ø§Øª (Ù†Ø¨Ø±Ø©)ØŒ ØªÙØ§Ø¹Ù„ (Ø³Ø¤Ø§Ù„ Ù„Ù„Ø¬Ù…Ù‡ÙˆØ±)ØŒ Ù„ØºØ© (Ø¹Ø¨Ø§Ø±Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©). Ù„Ø§ ØªØ­Ø§ÙˆÙ„ ØªØ±Ø¶ÙŠ Ø§Ù„Ø¬Ù…ÙŠØ¹â€¦ Ø±Ø¶Ù Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±.";
  }
  return "Ù†ØµÙŠØ­Ø© Ø³Ø±ÙŠØ¹Ø©: Ù‚Ù„Ù‘Ù„ Ø§Ù„Ø­Ø´ÙˆØŒ Ø§Ø±ÙØ¹ Ø§Ù„Ø«Ù‚Ø©ØŒ ÙˆØ®Ù„ÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ ÙÙ‚Ø±Ø© (Ù‚Ø±Ø§Ø±/Ø®Ù„Ø§ØµØ©) â€” Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± ÙŠØ­Ø¨ Ø§Ù„Ù„ÙŠ ÙŠÙÙ‡Ù…Ù‡ Ø¨Ø³Ø±Ø¹Ø© ğŸ˜„";
}

/* ---------- Judge ---------- */
function calcJudge() {
  const c = Number(els.sClarity?.value || 0);
  const s = Number(els.sStab?.value || 0);
  const e = Number(els.sEng?.value || 0);
  const l = Number(els.sLang?.value || 0);

  // weighted score
  const score = Math.round(c * 0.28 + s * 0.26 + e * 0.24 + l * 0.22);

  let decision = "ÙŠÙ…Ø±Ù‘";
  if (score >= 85) decision = "Ù…Ù…ØªØ§Ø² â€” Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù…ÙŠ";
  else if (score >= 70) decision = "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§ â€” ÙŠØ­ØªØ§Ø¬ ØµÙ‚Ù„ Ø¨Ø³ÙŠØ·";
  else if (score >= 55) decision = "Ø¬ÙŠØ¯ â€” ÙŠØ­ØªØ§Ø¬ ØªØ¯Ø±ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ";
  else decision = "ØºÙŠØ± Ø¬Ø§Ù‡Ø² â€” Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶ÙˆØ­ ÙˆØ§Ù„Ø«Ø¨Ø§Øª";

  if (els.finalScore) els.finalScore.textContent = score;
  if (els.decision) els.decision.textContent = decision;

  return { score, decision, c, s, e, l };
}

function buildReport() {
  const r = calcJudge();
  const txt =
`SpeakXR X-Stage PRO â€” Jury Report
--------------------------------
Score: ${r.score}
Decision: ${r.decision}

Breakdown:
- Clarity: ${r.c}
- Stability: ${r.s}
- Engagement: ${r.e}
- Language: ${r.l}

Session Metrics (Mock):
- WPM: ${state.wpm}
- Confidence: ${state.conf}%
- Fillers: ${state.filler}
- Tone: ${state.tone}

Recommendations:
1) Keep WPM within 120â€“160.
2) Replace fillers with short pause.
3) End each segment with a clear takeaway.
`;
  if (els.report) els.report.textContent = txt;
  return txt;
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    setStatus("ok", "ØªÙ… Ø§Ù„Ù†Ø³Ø®", "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¬Ø§Ù‡Ø² Ù„Ù„ØµÙ‚");
  } catch {
    setStatus("warn", "Ù…Ø§Ù‚Ø¯Ø± Ø£Ù†Ø³Ø®", "Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±");
  }
}

/* ---------- Sessions Storage ---------- */
const KEY = "speakxr_sessions_v1";

function loadSessions() {
  try {
    const raw = localStorage.getItem(KEY);
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}

function saveSessions(list) {
  localStorage.setItem(KEY, JSON.stringify(list));
}

function renderSessions() {
  if (!els.sessions) return;
  const list = loadSessions();
  els.sessions.innerHTML = "";

  if (!list.length) {
    els.sessions.innerHTML = `<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©â€¦ Ø§Ø­ÙØ¸ Ø¬Ù„Ø³Ø© Ù…Ù† Ø²Ø± â€œØ­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©â€.</div>`;
    return;
  }

  list.slice().reverse().forEach((s) => {
    const row = document.createElement("div");
    row.className = "sessionItem";
    row.innerHTML = `
      <div>
        <b>${s.title}</b>
        <div class="muted" style="margin-top:4px">${s.time}</div>
      </div>
      <div>
        <b>${s.score ?? "â€”"}</b>
        <div class="muted" style="margin-top:4px">${s.decision ?? ""}</div>
      </div>
    `;
    els.sessions.appendChild(row);
  });
}

function saveCurrentSession() {
  const list = loadSessions();
  const now = new Date();
  const time = now.toLocaleString("ar-SA");
  const judge = calcJudge();
  const item = {
    id: String(now.getTime()),
    title: `Ø¬Ù„Ø³Ø© #${list.length + 1}`,
    time,
    wpm: state.wpm,
    conf: state.conf,
    filler: state.filler,
    tone: state.tone,
    score: judge.score,
    decision: judge.decision,
  };
  list.push(item);
  saveSessions(list);
  renderSessions();
  setStatus("ok", "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©", "ØªÙ„Ù‚Ø§Ù‡Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±");
}

/* ---------- Theme Toggle (simple) ---------- */
function toggleTheme() {
  document.body.classList.toggle("themeAlt");
  setStatus("ok", "ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·", "Ø°ÙˆÙ‚â€¦ Ø£Ù†Øª ØµØ§Ø­Ø¨ Ù…Ù†ØµØ© ğŸ˜„");
  wowPulse();
}

/* ---------- Wire Events ---------- */
function wire() {
  // session
  els.startBtn?.addEventListener("click", startSession);
  els.stopBtn?.addEventListener("click", stopSession);

  // theme
  els.themeBtn?.addEventListener("click", toggleTheme);

  // toggles
  els.toggleHUD?.addEventListener("click", toggleHUD);
  els.toggleAudience?.addEventListener("click", toggleAudience);
  els.toggleTele?.addEventListener("click", toggleTele);
  els.toggleVR?.addEventListener("click", toggleVR);

  // sliders
  els.hudSize?.addEventListener("input", (e) => setHudSize(e.target.value));
  els.audPower?.addEventListener("input", (e) => {
    state.audPower = Number(e.target.value);
    if (state.audOn) updateAudienceMood();
  });
  els.teleSpeed?.addEventListener("input", () => {
    if (state.teleOn) startTeleScroll();
  });

  // script apply
  els.applyScript?.addEventListener("click", () => {
    setTeleText(els.scriptInput?.value || "");
    setStatus("ok", "ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Øµ", "Ø§Ù„ØªÙ„Ù‚ÙŠÙ† Ø¬Ø§Ù‡Ø²");
    wowPulse();
  });

  // wow
  els.wowBtn?.addEventListener("click", () => {
    randomizeBars();
    if (!state.audOn) toggleAudience();
    if (!state.teleOn) toggleTele();
    wowPulse();
    setStatus("ok", "WOW Demo", "Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¢Ù† â€œØªØªØ­Ø±Ùƒâ€ ğŸ‘");
  });

  // XR page toggles mirror
  els.xrHud?.addEventListener("click", toggleHUD);
  els.xrAud?.addEventListener("click", toggleAudience);
  els.xrTele?.addEventListener("click", toggleTele);
  els.xrVr?.addEventListener("click", toggleVR);

  els.randBars?.addEventListener("click", randomizeBars);

  // tele apply from XR
  els.teleApply?.addEventListener("click", () => {
    setTeleText(els.teleArea?.value || "");
    setStatus("ok", "ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙ„Ù‚ÙŠÙ†", "Ø¬Ø§Ù‡Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø±Ø­");
  });

  // poke coach
  els.pokeCoach?.addEventListener("click", () => {
    const tip = coachAnswer("Ù†ØµÙŠØ­Ø©");
    els.miniOut && (els.miniOut.textContent = tip);
    setStatus("ok", "Ù†ØµÙŠØ­Ø© Ø¬Ø§Ù‡Ø²Ø©", "Ø±ÙˆØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù„Ùˆ ØªØ¨ÙŠ Ø£ÙƒØ«Ø±");
  });

  // Coach chat
  els.sendChat?.addEventListener("click", () => {
    const q = (els.chatInput?.value || "").trim();
    if (!q) return;
    pushChat(q, "me");
    els.chatInput.value = "";
    setTimeout(() => pushChat(coachAnswer(q), "bot"), 250);
  });
  els.chatInput?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") els.sendChat?.click();
  });

  // Judge
  els.calcJudge?.addEventListener("click", () => {
    const r = calcJudge();
    setStatus("ok", "ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø©", `Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${r.score}`);
    wowPulse();
  });
  els.makeReport?.addEventListener("click", () => {
    const txt = buildReport();
    setStatus("ok", "ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±", "ØªÙ‚Ø¯Ø± ØªÙ†Ø³Ø®Ù‡ Ø£Ùˆ ØªØ­ÙØ¸ Ø¬Ù„Ø³Ø©");
    wowPulse();
    return txt;
  });
  els.copyReport?.addEventListener("click", () => {
    const txt = els.report?.textContent || buildReport();
    copyText(txt);
  });

  // Reports
  els.saveSession?.addEventListener("click", saveCurrentSession);
  els.clearSessions?.addEventListener("click", () => {
    localStorage.removeItem(KEY);
    renderSessions();
    setStatus("warn", "ØªÙ… Ø§Ù„Ù…Ø³Ø­", "ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù†Ø­Ø°ÙØª");
  });

  // init visuals
  setHudSize(els.hudSize?.value || 18);
  state.audPower = Number(els.audPower?.value || 60);
  buildAudience(state.audPower);
  randomizeBars();
}

/* ---------- Boot ---------- */
function boot() {
  initRouter();
  wire();
  renderSessions();
  setStatus("ok", "Ø¬Ø§Ù‡Ø²", "Ø§Ø¶ØºØ· â€œØ¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©â€ ÙˆØ®Ù„Ù†Ø§ Ù†Ø·Ù„Ø¹ Ø£Ø¯Ø§Ø¡ Ø±Ø³Ù…ÙŠ");
  // seed
  state.conf = rand(45, 70);
  computeMetricsTick();
}
window.addEventListener("DOMContentLoaded", boot);

/* ---------- Optional alt theme ---------- */
(() => {
  const css = document.createElement("style");
  css.textContent = `
  body.themeAlt{
    background:
      radial-gradient(1200px 600px at 20% 10%, #ffb30022, transparent 55%),
      radial-gradient(900px 500px at 90% 25%, #00d4ff22, transparent 55%),
      radial-gradient(900px 600px at 40% 90%, #ff4d6d18, transparent 60%),
      linear-gradient(180deg, #070815, #101b3c);
  }
  .msg{
    max-width:78%;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    line-height:1.6;
    margin: 10px 0;
  }
  .msg.me{margin-right:auto; background: rgba(124,92,255,.14); border-color: rgba(124,92,255,.25)}
  .msg.bot{margin-left:auto; background: rgba(33,230,164,.12); border-color: rgba(33,230,164,.22)}
  .sessionItem{
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
    margin:10px 0;
  }
  `;
  document.head.appendChild(css);
})();
