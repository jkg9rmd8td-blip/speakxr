/* ================================
   SpeakXR SPA Router (FIXED)
   - يدعم: nav buttons + tabs + أي عنصر عنده data-go
   - يشتغل مع #hash
   - يتجنب لخبطة .page داخل aside (نستهدف .content فقط)
================================== */

(() => {
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  function normalizeKey(k) {
    return String(k || "")
      .trim()
      .toLowerCase()
      .replace(/^page-/, "")
      .replace(/^#/, "");
  }

  function getContentRoot() {
    // مهم: نشتغل على صفحات المحتوى فقط
    return document.querySelector(".content") || document.body;
  }

  function getPages() {
    const root = getContentRoot();
    return $$(".page[id^='page-']", root);
  }

  function hasPage(key) {
    const root = getContentRoot();
    return !!root.querySelector(`#page-${key}`);
  }

  function setActivePage(key, { silentHash=false } = {}) {
    key = normalizeKey(key);

    const root = getContentRoot();
    const pages = getPages();

    if (!key) key = "home";
    if (!root.querySelector(`#page-${key}`)) {
      // fallback: اول صفحة موجودة
      const first = pages[0]?.id?.replace("page-","") || "home";
      key = first;
    }

    // hide all pages
    pages.forEach(p => p.classList.remove("active"));

    // show target
    const target = root.querySelector(`#page-${key}`);
    if (target) target.classList.add("active");

    // تحديث حالة الأزرار اللي فوق (nav/tabs)
    // أي زر عنده data-go يطابق key
    $$("[data-go]").forEach(btn => {
      const bKey = normalizeKey(btn.getAttribute("data-go"));
      btn.classList.toggle("active", bKey === key);
      btn.setAttribute("aria-current", bKey === key ? "page" : "false");
    });

    // تحديث الـ hash
    if (!silentHash) {
      const newHash = `#${key}`;
      if (location.hash !== newHash) {
        history.replaceState(null, "", newHash);
      }
    }

    // ديباغ لطيف في الكونسل
    // console.log("➡️ Page:", key);
  }

  function wireClicks() {
    // يلتقط أي ضغط على عنصر عنده data-go (حتى لو داخل زر/أيقونة)
    document.addEventListener("click", (e) => {
      const el = e.target.closest("[data-go]");
      if (!el) return;

      const key = normalizeKey(el.getAttribute("data-go"));
      if (!key) return;

      // منع أي سلوك افتراضي لو كان رابط
      e.preventDefault();

      // إذا الصفحة موجودة فعلاً
      if (hasPage(key)) {
        setActivePage(key);
      } else {
        // لو تضغط زر وما عندك صفحة له.. نوديه للـ home بدل ما يصير “ميت”
        setActivePage("home");
      }
    }, { passive: false });
  }

  function wireHash() {
    window.addEventListener("hashchange", () => {
      const key = normalizeKey(location.hash);
      setActivePage(key, { silentHash: true });
    });
  }

  function boot() {
    // تأكد إن عندك على الأقل صفحة وحدة
    const pages = getPages();
    if (!pages.length) {
      console.warn("⚠️ ما لقيت صفحات داخل .content. تأكد أن sections .page داخل content مو داخل aside.");
      return;
    }

    wireClicks();
    wireHash();

    // افتح الصفحة حسب الـ hash أو home
    const initial = normalizeKey(location.hash) || "home";
    setActivePage(initial, { silentHash: true });
  }

  document.addEventListener("DOMContentLoaded", boot);
})();
